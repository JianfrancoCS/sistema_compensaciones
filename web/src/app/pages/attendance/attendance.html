<div class="p-4 h-full flex flex-col">
  <p-toast></p-toast>

  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-xl font-semibold text-gray-600">Gestión de Asistencia</h1>
    <p class="text-sm text-gray-500 mt-1">Selecciona la vista de Entrada o Salida para gestionar asistencias</p>
  </div>

  <!-- Tabs for Entrada/Salida -->
  <p-tabs [(value)]="activeTab" styleClass="flex-1" contentStyleClass="h-full" (onChange)="activeTab() === '0' ? setEntryType(true) : setEntryType(false)">
    <!-- TAB 1: ENTRADA -->
    <p-tabpanel value="0">
      <ng-template #header>
        <div class="flex items-center gap-2 px-2">
          <i class="pi pi-arrow-right text-green-600"></i>
          <span class="font-semibold">ENTRADA</span>
        </div>
      </ng-template>

      <div class="h-full flex flex-col py-4">
        <!-- Configuration Section -->
        <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Tipo de Marcado -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-users text-gray-500 mr-2"></i>
                Tipo de Marcado
              </label>
              <div class="flex gap-2">
                <button
                  pButton
                  type="button"
                  [label]="'Empleado'"
                  icon="pi pi-user"
                  [class]="!isExternalMarking() ? 'p-button-primary' : 'p-button-outlined'"
                  class="flex-1 p-button-sm"
                  (click)="setMarkingType(false)">
                </button>
                <button
                  pButton
                  type="button"
                  [label]="'Externo'"
                  icon="pi pi-users"
                  [class]="isExternalMarking() ? 'p-button-primary' : 'p-button-outlined'"
                  class="flex-1 p-button-sm"
                  (click)="setMarkingType(true)">
                </button>
              </div>
            </div>

            <!-- Fundo -->
            <div>
              <label for="subsidiaryPublicId-entry" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-building text-gray-500 mr-2"></i>
                Fundo <span class="text-red-500">*</span>
              </label>
              <p-select
                id="subsidiaryPublicId-entry"
                [formControl]="subsidiaryControl"
                [options]="subsidiaries()"
                optionLabel="name"
                optionValue="publicId"
                placeholder="Seleccione un fundo"
                styleClass="w-full"
                [fluid]="true"
                appendTo="body">
              </p-select>
            </div>

            <!-- Razón de Marcado -->
            <div>
              <label for="markingReasonPublicId-entry" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-tag text-gray-500 mr-2"></i>
                {{ isExternalMarking() ? 'Razón (Externo)' : 'Razón (Empleado)' }} <span class="text-red-500">*</span>
              </label>
              <p-select
                id="markingReasonPublicId-entry"
                [formControl]="markingReasonControl"
                [options]="isExternalMarking() ? externalMarkingReasons() : markingReasons()"
                optionLabel="name"
                optionValue="publicId"
                placeholder="Seleccione una razón"
                styleClass="w-full"
                [fluid]="true"
                appendTo="body">
              </p-select>
            </div>
          </div>
        </div>

        <!-- Main Content - 3 Columns -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
          <!-- Escanear QR -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col">
            <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
              <i class="pi pi-qrcode text-gray-600"></i>
              <h2 class="text-base font-semibold text-gray-700">Escanear Código QR</h2>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
              <app-continuous-barcode-scanner
                [isActive]="true"
                (onBarcodeScanned)="onScanSuccess($event)">
              </app-continuous-barcode-scanner>
            </div>
          </div>

          <!-- Entrada Manual -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
              <i class="pi pi-pencil text-gray-600"></i>
              <h2 class="text-base font-semibold text-gray-700">Entrada Manual</h2>
            </div>

            <form [formGroup]="attendanceForm" (ngSubmit)="markAttendance()">
              <div class="space-y-2 mb-4">
                <label for="personDocumentNumber-entry" class="flex items-center gap-2 font-semibold text-sm text-gray-700">
                  <i class="pi pi-id-card text-gray-500"></i>
                  Número de Documento
                  <span class="text-red-500">*</span>
                </label>
                <input
                  pInputText
                  id="personDocumentNumber-entry"
                  formControlName="personDocumentNumber"
                  class="w-full"
                  placeholder="Ej: 12345678"
                  autocomplete="off" />
                @if (attendanceForm.get('personDocumentNumber')?.invalid && attendanceForm.get('personDocumentNumber')?.touched) {
                  <small class="text-red-500 flex items-center gap-1">
                    <i class="pi pi-exclamation-circle text-xs"></i>
                    El número de documento es requerido
                  </small>
                }
              </div>

              <button
                pButton
                type="submit"
                label="Registrar Entrada"
                icon="pi pi-arrow-right"
                class="w-full p-button-success"
                [disabled]="loading() || attendanceForm.invalid"
                [loading]="loading()">
              </button>
            </form>
          </div>

          <!-- Registros Recientes -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col">
            <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
              <i class="pi pi-list text-gray-600"></i>
              <h2 class="text-base font-semibold text-gray-700">Entradas Recientes</h2>
            </div>

            <div class="flex-1 overflow-auto">
              @if (entryRecords().length === 0) {
                <div class="flex flex-col items-center justify-center h-full text-gray-400">
                  <i class="pi pi-inbox text-4xl mb-2"></i>
                  <p class="text-sm">No hay entradas registradas aún</p>
                </div>
              }

              @if (entryRecords().length > 0) {
                <div class="space-y-2">
                  @for (record of entryRecords(); track record.timestamp) {
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                      <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-700">{{ record.documentNumber }}</span>
                        <span class="text-green-600 text-xs font-medium">
                          <i class="pi pi-arrow-right mr-1"></i>
                          {{ record.entryType }}
                        </span>
                      </div>
                      <div class="text-xs text-gray-500">
                        <div class="mb-1">
                          <i class="pi pi-clock mr-1"></i>
                          {{ record.time }}
                        </div>
                        <div>
                          <i class="pi pi-tag mr-1"></i>
                          {{ record.markingReason }}
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </p-tabpanel>

    <!-- TAB 2: SALIDA -->
    <p-tabpanel value="1">
      <ng-template #header>
        <div class="flex items-center gap-2 px-2">
          <i class="pi pi-arrow-left text-red-600"></i>
          <span class="font-semibold">SALIDA</span>
        </div>
      </ng-template>

      <div class="h-full flex flex-col py-4">
        <!-- Configuration Section -->
        <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Tipo de Marcado -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-users text-gray-500 mr-2"></i>
                Tipo de Marcado
              </label>
              <div class="flex gap-2">
                <button
                  pButton
                  type="button"
                  [label]="'Empleado'"
                  icon="pi pi-user"
                  [class]="!isExternalMarking() ? 'p-button-primary' : 'p-button-outlined'"
                  class="flex-1 p-button-sm"
                  (click)="setMarkingType(false)">
                </button>
                <button
                  pButton
                  type="button"
                  [label]="'Externo'"
                  icon="pi pi-users"
                  [class]="isExternalMarking() ? 'p-button-primary' : 'p-button-outlined'"
                  class="flex-1 p-button-sm"
                  (click)="setMarkingType(true)">
                </button>
              </div>
            </div>

            <!-- Fundo -->
            <div>
              <label for="subsidiaryPublicId-exit" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-building text-gray-500 mr-2"></i>
                Fundo <span class="text-red-500">*</span>
              </label>
              <p-select
                id="subsidiaryPublicId-exit"
                [formControl]="subsidiaryControl"
                [options]="subsidiaries()"
                optionLabel="name"
                optionValue="publicId"
                placeholder="Seleccione un fundo"
                styleClass="w-full"
                [fluid]="true"
                appendTo="body">
              </p-select>
            </div>

            <!-- Razón de Marcado -->
            <div>
              <label for="markingReasonPublicId-exit" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-tag text-gray-500 mr-2"></i>
                {{ isExternalMarking() ? 'Razón (Externo)' : 'Razón (Empleado)' }} <span class="text-red-500">*</span>
              </label>
              <p-select
                id="markingReasonPublicId-exit"
                [formControl]="markingReasonControl"
                [options]="isExternalMarking() ? externalMarkingReasons() : markingReasons()"
                optionLabel="name"
                optionValue="publicId"
                placeholder="Seleccione una razón"
                styleClass="w-full"
                [fluid]="true"
                appendTo="body">
              </p-select>
            </div>
          </div>
        </div>

        <!-- Main Content - 3 Columns -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
          <!-- Escanear QR -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col">
            <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
              <i class="pi pi-qrcode text-gray-600"></i>
              <h2 class="text-base font-semibold text-gray-700">Escanear Código QR</h2>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
              <app-continuous-barcode-scanner
                [isActive]="true"
                (onBarcodeScanned)="onScanSuccess($event)">
              </app-continuous-barcode-scanner>
            </div>
          </div>

          <!-- Entrada Manual -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
              <i class="pi pi-pencil text-gray-600"></i>
              <h2 class="text-base font-semibold text-gray-700">Entrada Manual</h2>
            </div>

            <form [formGroup]="attendanceForm" (ngSubmit)="markAttendance()">
              <div class="space-y-2 mb-4">
                <label for="personDocumentNumber-exit" class="flex items-center gap-2 font-semibold text-sm text-gray-700">
                  <i class="pi pi-id-card text-gray-500"></i>
                  Número de Documento
                  <span class="text-red-500">*</span>
                </label>
                <input
                  pInputText
                  id="personDocumentNumber-exit"
                  formControlName="personDocumentNumber"
                  class="w-full"
                  placeholder="Ej: 12345678"
                  autocomplete="off" />
                @if (attendanceForm.get('personDocumentNumber')?.invalid && attendanceForm.get('personDocumentNumber')?.touched) {
                  <small class="text-red-500 flex items-center gap-1">
                    <i class="pi pi-exclamation-circle text-xs"></i>
                    El número de documento es requerido
                  </small>
                }
              </div>

              <button
                pButton
                type="submit"
                label="Registrar Salida"
                icon="pi pi-arrow-left"
                class="w-full p-button-danger"
                [disabled]="loading() || attendanceForm.invalid"
                [loading]="loading()">
              </button>
            </form>
          </div>

          <!-- Registros Recientes -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col">
            <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
              <i class="pi pi-list text-gray-600"></i>
              <h2 class="text-base font-semibold text-gray-700">Salidas Recientes</h2>
            </div>

            <div class="flex-1 overflow-auto">
              @if (exitRecords().length === 0) {
                <div class="flex flex-col items-center justify-center h-full text-gray-400">
                  <i class="pi pi-inbox text-4xl mb-2"></i>
                  <p class="text-sm">No hay salidas registradas aún</p>
                </div>
              }

              @if (exitRecords().length > 0) {
                <div class="space-y-2">
                  @for (record of exitRecords(); track record.timestamp) {
                    <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                      <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-700">{{ record.documentNumber }}</span>
                        <span class="text-red-600 text-xs font-medium">
                          <i class="pi pi-arrow-left mr-1"></i>
                          {{ record.entryType }}
                        </span>
                      </div>
                      <div class="text-xs text-gray-500">
                        <div class="mb-1">
                          <i class="pi pi-clock mr-1"></i>
                          {{ record.time }}
                        </div>
                        <div>
                          <i class="pi pi-tag mr-1"></i>
                          {{ record.markingReason }}
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </p-tabpanel>
  </p-tabs>
</div>
<div class="p-4 h-full flex flex-col">
  <p-toast></p-toast>

  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-xl font-semibold text-gray-600">
      <i class="pi pi-arrow-right text-green-600 mr-2"></i>
      Registro de Entradas
    </h1>
    <p class="text-sm text-gray-500 mt-1">Escanea un código QR o ingresa el documento manualmente</p>
  </div>

  <!-- Configuration Section -->
  <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Tipo de Marcado -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="pi pi-users text-gray-500 mr-2"></i>
          Tipo de Marcado
        </label>
        <div class="flex gap-2">
          <button
            pButton
            type="button"
            [label]="'Empleado'"
            icon="pi pi-user"
            [class]="!isExternalMarking() ? 'p-button-primary' : 'p-button-outlined'"
            class="flex-1 p-button-sm"
            (click)="setMarkingType(false)">
          </button>
          <button
            pButton
            type="button"
            [label]="'Externo'"
            icon="pi pi-users"
            [class]="isExternalMarking() ? 'p-button-primary' : 'p-button-outlined'"
            class="flex-1 p-button-sm"
            (click)="setMarkingType(true)">
          </button>
        </div>
      </div>

      <!-- Fundo -->
      <div>
        <label for="subsidiaryPublicId" class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="pi pi-building text-gray-500 mr-2"></i>
          Fundo <span class="text-red-500">*</span>
        </label>
        <p-select
          id="subsidiaryPublicId"
          [formControl]="subsidiaryControl"
          [options]="subsidiaries()"
          optionLabel="name"
          optionValue="publicId"
          placeholder="Seleccione un fundo"
          styleClass="w-full"
          [fluid]="true"
          appendTo="body">
        </p-select>
      </div>

      <!-- Razón de Marcado -->
      <div>
        <label for="markingReasonPublicId" class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="pi pi-tag text-gray-500 mr-2"></i>
          {{ isExternalMarking() ? 'Razón (Externo)' : 'Razón (Empleado)' }} <span class="text-red-500">*</span>
        </label>
        <p-select
          id="markingReasonPublicId"
          [formControl]="markingReasonControl"
          [options]="isExternalMarking() ? externalMarkingReasons() : markingReasons()"
          optionLabel="name"
          optionValue="publicId"
          placeholder="Seleccione una razón"
          styleClass="w-full"
          [fluid]="true"
          appendTo="body">
        </p-select>
      </div>
    </div>
  </div>

  <!-- Main Content - 2 Columns -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
    <!-- Columna Izquierda: Escáner QR + Entrada Manual -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col">
      <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
        <i class="pi pi-qrcode text-gray-600"></i>
        <h2 class="text-base font-semibold text-gray-700">Escanear Código QR</h2>
      </div>

      <!-- Scanner -->
      <div class="flex-1 flex flex-col items-center justify-center mb-6">
        <app-continuous-barcode-scanner
          [isActive]="true"
          (onBarcodeScanned)="onScanSuccess($event)">
        </app-continuous-barcode-scanner>
      </div>

      <!-- Entrada Manual debajo del escáner -->
      <form [formGroup]="attendanceForm" (ngSubmit)="markAttendance()">
        <div class="space-y-2 mb-4">
          <label for="personDocumentNumber" class="flex items-center gap-2 font-semibold text-sm text-gray-700">
            <i class="pi pi-id-card text-gray-500"></i>
            Número de Documento
            <span class="text-red-500">*</span>
          </label>
          <input
            pInputText
            id="personDocumentNumber"
            formControlName="personDocumentNumber"
            class="w-full"
            placeholder="Ej: 12345678"
            autocomplete="off" />
          @if (attendanceForm.get('personDocumentNumber')?.invalid && attendanceForm.get('personDocumentNumber')?.touched) {
            <small class="text-red-500 flex items-center gap-1">
              <i class="pi pi-exclamation-circle text-xs"></i>
              El número de documento es requerido
            </small>
          }
        </div>

        <button
          pButton
          type="submit"
          label="Registrar Entrada"
          icon="pi pi-arrow-right"
          class="w-full p-button-success"
          [disabled]="loading() || attendanceForm.invalid"
          [loading]="loading()">
        </button>
      </form>
    </div>

    <!-- Columna Derecha: Registros Recientes -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 flex flex-col">
      <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
        <i class="pi pi-list text-gray-600"></i>
        <h2 class="text-base font-semibold text-gray-700">Entradas Recientes</h2>
      </div>

      <div class="flex-1 overflow-auto">
        @if (entryRecords().length === 0) {
          <div class="flex flex-col items-center justify-center h-full text-gray-400">
            <i class="pi pi-inbox text-4xl mb-2"></i>
            <p class="text-sm">No hay entradas registradas aún</p>
          </div>
        }

        @if (entryRecords().length > 0) {
          <div class="space-y-2">
            @for (record of entryRecords(); track record.timestamp) {
              <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-semibold text-gray-700">{{ record.documentNumber }}</span>
                  <span class="text-green-600 text-xs font-medium">
                    <i class="pi pi-arrow-right mr-1"></i>
                    {{ record.entryType }}
                  </span>
                </div>
                <div class="text-xs text-gray-500">
                  <div class="mb-1">
                    <i class="pi pi-clock mr-1"></i>
                    {{ record.time }}
                  </div>
                  <div>
                    <i class="pi pi-tag mr-1"></i>
                    {{ record.markingReason }}
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</div>